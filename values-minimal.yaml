# Minimal ArgoCD configuration for SOPS with Vault decryption

configs:
  cm:
    create: true
    # Enable SOPS decryption via helm-secrets
    helm.valuesFileSchemes: >-
      ref+sops,
      secrets,
      https

# Repo Server configuration - handles decryption
repoServer:
  env:
    # Configure helm-secrets plugin
    - name: HELM_PLUGINS
      value: /custom-tools/helm-plugins/
    - name: HELM_SECRETS_BACKEND
      value: sops
    - name: HELM_SECRETS_SOPS_PATH
      value: /custom-tools/sops
    - name: HELM_SECRETS_HELM_PATH
      value: /usr/local/bin/helm
    
    # Vault authentication for SOPS
    - name: VAULT_ADDR
      value: http://vault.vault.svc.cluster.local:8200
    - name: VAULT_TOKEN
      value: root

  # Install SOPS and helm-secrets
  initContainers:
    - name: download-tools
      image: alpine:latest
      command: [sh, -ec]
      env:
        - name: HELM_SECRETS_VERSION
          value: "4.6.0"
        - name: SOPS_VERSION
          value: "3.8.1"
      args:
        - |
          mkdir -p /custom-tools/helm-plugins
          
          echo "Installing helm-secrets..."
          wget -qO- https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/helm-secrets.tar.gz | tar -C /custom-tools/helm-plugins -xzf-
          
          echo "Installing SOPS..."
          wget -qO /custom-tools/sops https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64
          
          chmod +x /custom-tools/sops
      volumeMounts:
        - mountPath: /custom-tools
          name: custom-tools

  volumes:
    - name: custom-tools
      emptyDir: {}

  volumeMounts:
    - mountPath: /custom-tools
      name: custom-tools
